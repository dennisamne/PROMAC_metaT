---
title: "PROMAC_MetaT"
author: "Dennis Amnebrink"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
      toc: yes
      toc_float:
        collapse: no
      fig_caption: yes
      code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
#Loading libraries
library(tidyverse)
library(vegan)
library(pheatmap)
library(data.table)
library(kableExtra)
```

```{r constants}
SIGNIFICANCE = 0.05
DIFF_TRESHOLD = 2.5
```

```{r R_colours}
GEOM_COL_COLOURS = c(
  RColorBrewer::brewer.pal(12, name = 'Paired'))

TREAT_COLOURS <- c("blue","green3","red","yellow4")
```




```{r files, cache=TRUE}
#File to connect NGI ID with our own classification ID, add the µ-values to this file for testing later, or do that in a sep file?
sample_ID <- read_tsv("../data/J.Pinhassi_21_02_sample_info.txt") %>%
  dplyr::select(1:2) %>%
  dplyr::rename(sample = 1, sample_name = 2) %>%
  mutate(sample_name = str_replace(sample_name, "[0-9]*:","")) %>%
  separate(sample_name, c("treatment","timepoint"), sep = ",") %>%
  mutate(treatment = gsub("NT","TN", treatment)) %>%
  mutate(sample_name = paste(timepoint, treatment, sep = "_")) %>%
  separate(treatment, c("treatment","replicate"), sep = -1) %>%
  mutate(tre_rep = gsub("_","", sample_name)) %>%
  mutate(tre_rep = toupper(tre_rep)) %>%
  mutate(day = case_when( timepoint == "t3" ~ 10,
                          TRUE ~ 17
                          )
         )

#Reading in annotations
eggnogs <- read_tsv("../data/eggnog_annotations.tsv.gz")

#Reading in taxonomic annotation of reads
taxonomy <- read_tsv("../data/eukulele_phylodb.tsv") %>%
  select(-species) %>%
  rename(species = "genus", genus = "family", family = "order", order = "class", class = "phylum", phylum = "kingdom")  %>%
  mutate_all(function(x) ifelse(str_detect(x, '_X'), NA, x)) %>% #Removing _X-annotations
  mutate_all(function(x) ifelse(str_detect(x, 'environmental'), NA, x)) %>% # Removing environmental - annotations this is considered the same as NA
  mutate_all(function(x) ifelse(str_detect(x, 'Misc'), NA, x)) %>%
  mutate_all(function(x) ifelse(str_detect(x, 'unclassified'), NA, x))
  
  
#Count file for all orfs, tpm is calculated per sample
bbmap <- fread("../data/bbmap_counts.tsv.gz", sep = "\t") %>%
              filter(count > 0)  %>%                               # removing 0 counts to reduce size of table
              mutate(Geneid = str_replace(Geneid, "[0-9]*_",""),   # Joining in chr and geneid to match format of eggnog naming.
                     orf = paste(Chr,Geneid, sep = "_"),
                     sample = str_extract(sample, "P[0-9]*_[0-9]*")) %>% # Removing extra numbers in sample to match sample_ID format
              dplyr::select(-Geneid,-Chr) %>%
              dplyr::select(orf,Start,End,Strand,Length,sample,count,tpm) 

#Overarching stats for all sample files
overall_stats <- read_tsv("../data/overall_stats.tsv") %>%
  dplyr::select(-2,-3)                                                   # Removing empty columns

target_genes <- read_tsv("../data/list_of_genes.tsv") 

mu_values <- read_tsv("../data/mu.tsv")

#Add maintenance respiration values
Rm <- read_tsv("../data/Rm_values.tsv") %>%
   mutate(tre_rep = paste(timepoint, treatment, replicate, sep = "")) 

nut_conc <- read_tsv("../data/nutrient_concentrations.tsv") # Are in microG/L

module_legend <- read_tsv("../data/module_legend.tsv", col_names = c("KEGG_Module","Entry"))
```

```{r, eval=FALSE}
obj <- eggnogs %>% 
  distinct(orf, seed_eggNOG_ortholog) %>% 
  group_by(seed_eggNOG_ortholog) %>% 
  tally() %>% 
  ungroup() %>%
  mutate( 
    seed_eggNOG_ortholog = factor(seed_eggNOG_ortholog) %>% forcats::fct_reorder(n, .desc = TRUE)
    )

 obj %>%
   ggplot(mapping = aes(x = seed_eggNOG_ortholog, y = n)) +
  geom_point()
```

```{r read_overview}
#Add one with taxonomic annotation too, and one with original reads
  overall_stats %>% 
    gather(key = "process", value = "value", c(2:4)) %>%
    mutate(process = as_factor(process)) %>%
    ggplot(mapping = aes(x = process, y = value, group = process, fill = process)) +
    geom_boxplot() +
    ggtitle("Boxplot distribution of reads throughout pipeline")
```

## Plotting the number of reads to each domain to characterize community
```{r ASV-domain-fidelity}
taxonomy %>%
  group_by(domain) %>%
  tally() %>%
  ungroup() %>%
  ggplot(mapping = aes(x = domain, y = n, group = domain, fill = domain)) +
  geom_col()
```

```{r ASV-domain-abundance}
bbmap %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(domain) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  mutate(percent = count/sum(count)) %>%
  ggplot(mapping = aes(x = domain, y = percent, group = domain, fill = domain)) +
  geom_col() +
  theme(axis.text.x = element_text(face = c("plain","bold","plain","plain","plain")))
```

# Removing non-prokaryotic reads
```{r}
#Removing non-prokreads as well as recalculating tpm over prok frac.
bbmap_p <- bbmap %>% 
  semi_join(taxonomy %>% filter(domain %in% c("Bacteria", "Archaea")), 
            by = "orf") %>%
  dplyr::select(-tpm) %>%
   group_by(sample) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
   ungroup()
```

```{r overview_table_tax_tpm, warning=FALSE,message=FALSE, results=FALSE }
bbmap_p %>%
  inner_join(eggnogs, by = "orf") %>%
  inner_join(taxonomy, by = "orf") %>%
  select(-counts) %>%
  write_tsv("../results/overview_table.tsv")
```

## COG-nMDS
```{r cog-cat-overview, eval=FALSE}
#COG-categories shoed no pattern, they are very large as well, the next chunk shows clear patterns (higher resolution)
orf_mat <- bbmap_p %>%
  inner_join(eggnogs, by = "orf") %>% #6674350 rows
  inner_join(sample_ID, by = "sample") %>%
  select(best_og_cat, tpm, sample_name) %>%
  separate_rows(best_og_cat, sep = '(?<=.)(?=.)') %>% # Not sure how this separator works, but it works
  group_by(sample_name, best_og_cat) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  spread(best_og_cat, tpm, fill = 0) %>%
  column_to_rownames("sample_name") %>%
  as.matrix() 

  orf_mat_hellinger <- decostand(orf_mat[,-1], method = "hellinger") # Removing the unannotated functional category and doing helllinger
  
  nmds <- metaMDS(orf_mat[,-1], distance = "bray", k = 2) 
  nmds <- metaMDS(orf_mat_hellinger, distance = "bray", k = 2) 
  
  
  as.data.frame(nmds$points) %>%
    rownames_to_column("sample_name") %>%
    inner_join(sample_ID, by = "sample_name") %>%
    #separate(treatment, c("treatment", "replicate"), sep = -1) %>%
    ggplot(mapping = aes(x = MDS1, y = MDS2, fill = treatment, colour = treatment, shape = timepoint)) +
    geom_point() +
    scale_colour_manual(values = GEOM_COL_COLOURS) +
    ggtitle("nMDS based on COG-categories") +
    ylab("NMDS2") +
    xlab(paste0("NMDS1\n", "stress=", round(nmds$stress, 3))) 
    ggsave("../results/NMDS_COG_CATS.png")
    
  PCA <- rda(orf_mat[,-1], distance = "bray") 
  PCA <- rda(orf_mat_hellinger, distance = "bray") 
  
   eigenvalues <- as.data.frame(PCA$CA$eig) %>%
    rownames_to_column("PC_axes") %>%
    rename(eigenvalues = "PCA$CA$eig") %>%
    mutate(eigenvalues_variation_explained = (eigenvalues/sum(eigenvalues) * 100))
   
   as.data.frame(PCA$CA$u) %>%
     rownames_to_column("sample_name") %>%
     inner_join(sample_ID, by = "sample_name") %>%
     #separate(treatment, c("treatment", "replicate"), sep = -1) %>%
     ggplot(mapping = aes(x = PC1, y = PC2, fill = treatment, colour = treatment, shape = timepoint)) +
     geom_point(aes(size = 10)) +
     scale_colour_manual(values = GEOM_COL_COLOURS) +
     xlab(paste("PC1", round(eigenvalues$eigenvalues_variation_explained[1], digits = 2),"%", sep = " ")) +
     ylab(paste("PC2", round(eigenvalues$eigenvalues_variation_explained[2], digits = 2),"%", sep = " ")) 
     ggtitle("PCA based on COG-categories") 
     ggsave("../results/PCA_COG_CATS.png")
```

## eggNOG-PCA
```{r eggNOG_overview, cache=TRUE}
   # Doing nmds and PCA on eggnogs instead, Looks a lot better
orf_mat <-  bbmap_p %>%
  inner_join(eggnogs, by = "orf") %>% #6674350 rows
  inner_join(sample_ID, by = "sample") %>%
  rename(eggNOG_OGs = "eggNOG OGs") %>%
  select(eggNOG_OGs, tpm, sample_name) %>%
  separate_rows(eggNOG_OGs, sep = ',') %>% 
  group_by(sample_name, eggNOG_OGs) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  spread(eggNOG_OGs, tpm, fill = 0) %>%
  column_to_rownames("sample_name") %>%
  as.matrix() 
   
   orf_mat_hellinger <- decostand(orf_mat[,-1], method = "hellinger") # Removing the unannotated functional category and doing helllinger¨
     
    nmds <- metaMDS(orf_mat[,-1], distance = "bray", k = 2) 
   
  
  as.data.frame(nmds$points) %>%
    rownames_to_column("sample_name") %>%
    inner_join(sample_ID, by = "sample_name") %>%
    #separate(treatment, c("treatment", "replicate"), sep = -1) %>%
    ggplot(mapping = aes(x = MDS1, y = MDS2, fill = treatment, colour = treatment, shape = timepoint)) +
    geom_point() +
    scale_colour_manual(values = GEOM_COL_COLOURS) +
    ggtitle("nMDS based on eggNOGS") +
    ylab("NMDS2") +
    xlab(paste0("NMDS1\n", "stress=", round(nmds$stress, 3))) 
    ggsave("../results/NMDS_eggNOG.png")
    
    
  nmds <- metaMDS(orf_mat_hellinger, distance = "bray", k = 2) 
     
  as.data.frame(nmds$points) %>%
    rownames_to_column("sample_name") %>%
    inner_join(sample_ID, by = "sample_name") %>%
    #separate(treatment, c("treatment", "replicate"), sep = -1) %>%
    ggplot(mapping = aes(x = MDS1, y = MDS2, fill = treatment, colour = treatment, shape = timepoint)) +
    geom_point() +
    scale_colour_manual(values = GEOM_COL_COLOURS) +
    ggtitle("nMDS based on eggNOGS") +
    ylab("NMDS2") +
    xlab(paste0("NMDS1\n", "stress=", round(nmds$stress, 3))) 
    ggsave("../results/NMDS_hellinger_eggNOG.png")
  
  
  PCA <- rda(orf_mat_hellinger, distance = "bray") 
  
   eigenvalues <- as.data.frame(PCA$CA$eig) %>%
    rownames_to_column("PC_axes") %>%
    rename(eigenvalues = "PCA$CA$eig") %>%
    mutate(eigenvalues_variation_explained = (eigenvalues/sum(eigenvalues) * 100))
   
   as.data.frame(PCA$CA$u) %>%
     rownames_to_column("sample_name") %>%
     inner_join(sample_ID, by = "sample_name") %>%
     #separate(treatment, c("treatment", "replicate"), sep = -1) %>%
     ggplot(mapping = aes(x = PC1, y = PC2, fill = treatment, colour = treatment, shape = timepoint)) +
     geom_point() +
     scale_colour_manual(values = GEOM_COL_COLOURS) +
     xlab(paste("PC1", round(eigenvalues$eigenvalues_variation_explained[1], digits = 2),"%", sep = " ")) +
     ylab(paste("PC2", round(eigenvalues$eigenvalues_variation_explained[2], digits = 2),"%", sep = " ")) +
     ggtitle("PCA based on eggNOGS") +
     theme_minimal() +
     theme(panel.grid = element_blank()) +
      geom_vline(xintercept = 0, linetype = "dashed", size = 0.5) +
     geom_hline(yintercept=0, linetype="dashed", size = 0.5) 
     ggsave("../results/PCA_hellinger_eggNOGS.png")
```

## Taxonomic PCA
```{r}

```

## PERMANOVA
```{r}
#Creating the env_matrix for the permanova
orf_mat.env <- orf_mat %>% 
  as.data.frame() %>%
  rownames_to_column("sample_name") %>%
  select(sample_name) %>%
  inner_join(sample_ID, by = "sample_name") %>%
  select(sample_name, treatment) %>%
  column_to_rownames("sample_name")

#Running the adonis with dummy variables to separate temperature and nutrients for the 2x2 design
orf_mat.env.dummy <- orf_mat.env %>%
  mutate(temp = ifelse(
    grepl("T", treatment),
    10,1)) %>%
    mutate(nutrients = ifelse(
      grepl("N", treatment),
    1,0),
    )

permanova <- adonis2(decostand(orf_mat[,-1], method = "hellinger") ~ nutrients*temp, data = orf_mat.env.dummy)

# Both are significant, and interaction effect occurs, this is seen regardless of which term is placed first in the sequential setup. But why does this not produce an interaction effect while margin is set instead of sequential??? Regardless of hellinger or not the setup is significant.

bdisp <- betadisper(vegdist(decostand(orf_mat[,-1], method ="hellinger"), method = "bray"), as.factor(orf_mat.env.dummy$treatment), type = "median")


anova(bdisp)

#Looking at the bdisp it looks well defined, and groups very separated. 
plot(bdisp)


#Running the betadisper and permutations, the homogeneity of multivariate dispersions is significant, both with and without hellinger, how to deal with this??? Disp looks acceptable with hellinger though, so use that.

#Correcting the multiple p-values with fdr-correction.
as.data.frame(permanova$`Pr(>F)`) %>%
  rename(p_value = 1) %>%
  filter(!is.na(p_value)) %>%
  mutate(fdr = p.adjust(p_value, method = "fdr"))
```

## How many reads are on average (tpm) annotated per taxonomic level??
```{r}
# Mean tpm
#bbmap_p %>%
#  inner_join(sample_ID, by = "sample") %>%
#  dplyr::select(-tpm) %>%
#  group_by(treatment,timepoint) %>%
#            mutate(t = count/Length) %>%
#            mutate(tpm = t/sum(t)*1e6) %>%
#            ungroup() %>%
#  inner_join(taxonomy, by = "orf") %>%
 # group_by(phylum, treatment, timepoint) %>%
 # summarise(tpm = sum(tpm)) %>%
 # ungroup() %>%
 # group_by(phylum) %>%
 # summarise(mean_tpm = mean(tpm)) %>%
 # ungroup() %>%
 # mutate(average_frac = mean_tpm/sum(mean_tpm))


# Here it is done by raw reads instead
frac_vec <- as.numeric(vector())
tax_lev <- colnames(taxonomy[4:9])

#Getting the fractions that are unannotated in each taxonomic level
for (lev in tax_lev) {
 
obj <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by = "orf") %>%
  dplyr::select(-tpm) %>%
  group_by(.[[lev]]) %>%
  summarise(sum_count = sum(count)) %>%
  ungroup() %>%
  mutate(frac_reads = sum_count/sum(sum_count)) %>% 
  filter(is.na(.)) %>% 
  pull(frac_reads)
  
frac_vec <- append(frac_vec, obj)
}

unannotated_frac <- as.data.frame(frac_vec, tax_lev) %>%
  rownames_to_column("taxlevel") %>%
  rename(unannotated_fraction = "frac_vec")

kable(unannotated_frac)
```

# Stacked bars for visualization of taxonomy
```{r}
#Create taxonomy layout with top10 phyla, or class or order for example.
top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, timepoint, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(phylum) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>% 
  pull(phylum)

# Line for mutating in the new annotation using 12 families only, and rest in other category
#mutate(Group = ifelse(grepl(paste(top10, collapse = "|"), family), paste0(family), "other"))

 #Adding one more colour to the scale
GEOM_COL_COLOURS1 = c(GEOM_COL_COLOURS, "#D3D3D3")
  
 bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  mutate(Group = ifelse(phylum %in% top12, paste0(phylum), "other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "other", after = 10))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('phylum', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("taxonomy of reads, phylum level") 
  ggsave("../results/taxonomy_phylum.png")
  

#Plotting again but with class
 top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, timepoint, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(class) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(class)
 
bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  mutate(Group = ifelse(class %in% top12, paste0(class), "other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "other", after = 10))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('class', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Taxonomy of reads, class level") 
  ggsave("../results/taxonomy_class.png")

#Plotting again but with order
 top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, timepoint, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  mutate(order_coa = coalesce(order, class, phylum)) %>%
  group_by(order_coa) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(order_coa)
 
bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  mutate(order_coa = coalesce(order, class, phylum)) %>%
   mutate(Group = ifelse(order_coa %in% top12, paste0(order_coa), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  mutate(Group = fct_recode(Group, P_Thaumarchaeota = "Thaumarchaeota", C_Gammaproteobacteria = "Gammaproteobacteria")) %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Taxonomy of reads, order level and up") 
  ggsave("../results/taxonomy_order.png")

#Plotting again but with family
 top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, timepoint, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(family) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  .$family
 
bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
   mutate(Group = ifelse(family %in% top12, paste0(family), "other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 10))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('family', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("taxonomy of reads, family level") 
  ggsave("../results/taxonomy_family.png")
```

## Family level taxonomy expression within phyla

### Bacteroidetes/Chlorobi group

Should I perhaps lump together the unclassified Flavobacteriales with the NA?
```{r}
#Family level expression in Bacteroidetes/Chlorobi group. total of 23 families, look at top12

#I need to set the variables, 1. taxonomic level (e.g phylum, order), 2. Group to summarise on e.g bacteroidetes/chlorobi group. 

tax_magnify <- function(taxlevel = "phylum", taxdf = taxonomy,  g = "Bacteroidetes/Chlorobi group", sampledf = sample_ID) {

  
  top11 <- bbmap_p %>%
    inner_join(taxdf, by= "orf") %>%
    filter(.[[taxlevel]] == g) %>%
    inner_join(sampledf, by = "sample") %>%
    group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
    group_by(family) %>%
    summarise(tpm = sum(tpm)) %>%
    ungroup() %>%
    distinct(family, tpm) %>%
    arrange(desc(tpm)) %>%
    slice(1:11) %>%
    pull(family)
  
  
  bbmap_p %>%
    inner_join(taxdf, by= "orf") %>%
    filter(.[[taxlevel]] == g) %>%
    inner_join(sampledf, by = "sample") %>%
    group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
    mutate(n_family = ifelse(family %in% top11, paste(family), "Other")) %>%
    group_by(n_family, treatment, timepoint) %>%
    summarise(tpm = sum(tpm)) %>%
    ungroup() %>%
    ggplot(mapping = aes(x = timepoint, y = tpm, fill = n_family)) +
    geom_col() +
    facet_wrap(~ treatment) +
    scale_fill_manual(values = GEOM_COL_COLOURS, na.value = "#D3D3D3") +
    ggtitle(g)

}
```

```{r bacteroidetes_chlorobi_families}
#New approach by moving NA -> other, this works so keep this as opposed to previous analysis.
top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(phylum == "Bacteroidetes/Chlorobi group") %>%
  group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  group_by(order_coa) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(order_coa)

#Make the expression relative within the bacteroidetes /chlorobi group
p1 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(phylum == "Bacteroidetes/Chlorobi group") %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  mutate(Group = ifelse(order_coa %in% top12, paste0(order_coa), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  #mutate(Group = fct_recode(Group, P_Thaumarchaeota = "Thaumarchaeota", C_Gammaproteobacteria = "Gammaproteobacteria")) %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Family expression bacteroidetes/Chlorobi Group") 
```

### Alphaproteobacteria
The proteobacterial expression was mainly explained by Alpha, Beta- and Gammaproteobacteria, with the highest fraction of Alphaproteobacteria in the T-treatment. Gammaproteobacteria was more common in the TN-treatment. Roughly half of the  alphaproteobacterial expression was derived from Rhodobacteraceae and Surface 1-category, the latter being part of the SAR11-clade and constituted by unclassified bacteria or the genus Pelagibacter sp.. The expression composition was similar across all treatments, with the tendency of higher expression by unknown Alphaproteobacteria at day 17 in the TN treatment.
```{r}
 tax_magnify(taxlevel = "class", g = "Alphaproteobacteria")

top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(class == "Alphaproteobacteria") %>%
  group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  group_by(order_coa) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(order_coa)

#Make the expression relative within the bacteroidetes /chlorobi group
p2 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(class == "Alphaproteobacteria") %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  mutate(Group = ifelse(order_coa %in% top12, paste0(order_coa), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  #mutate(Group = fct_recode(Group, P_Thaumarchaeota = "Thaumarchaeota", C_Gammaproteobacteria = "Gammaproteobacteria")) %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Family expression Alphaproteobacteria") 
```

### Gammaproteobacteria
In Gammaproteobacteria, expression composition was markedly different in the N-treatment as more than 25% of expression was explained by *Shewanellaceae* at both timepoints. In the TN-treatment Oceanospirillaceae was instead the most prominent during day 10 while expression was more even during day 17. The C-treatment showed the most diverse expression composition with the larger groups comprising Environmental Gammaproteobacteria and NA. 
```{r}
tax_magnify(taxlevel = "class", g = "Gammaproteobacteria")

top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(class == "Gammaproteobacteria") %>%
  group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  group_by(order_coa) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(order_coa)

#Make the expression relative within the bacteroidetes /chlorobi group
p3 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(class == "Gammaproteobacteria") %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  mutate(order_coa = coalesce(family, order, class, phylum)) %>%
  mutate(Group = ifelse(order_coa %in% top12, paste0(order_coa), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  #mutate(Group = fct_recode(Group, P_Thaumarchaeota = "Thaumarchaeota", C_Gammaproteobacteria = "Gammaproteobacteria")) %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Family expression Gammaproteobacteria") 
```

### Thaumarchaeota
The expression was represented mainly by undetermined thaumarchaeota families, of which the Genus *Nitrosopumilus sp.* was a member, a small fraction was attributed to the Cenarchaeaceae family.
```{r}
 tax_magnify(taxlevel = "phylum", g = "Thaumarchaeota")

top12 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(phylum == "Thaumarchaeota") %>%
  group_by(treatment,timepoint) %>%
              mutate(t = count/Length) %>%
              mutate(tpm = t/sum(t)*1e6) %>%
              ungroup() %>%
  mutate(order_coa = coalesce(genus, family, order, class, phylum)) %>%
  group_by(order_coa) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:12) %>%
  pull(order_coa)

#Make the expression relative within the bacteroidetes /chlorobi group
p4 <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  inner_join(taxonomy, by= "orf") %>%
  filter(phylum == "Thaumarchaeota") %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  mutate(order_coa = coalesce(genus, family, order, class, phylum)) %>%
  mutate(Group = ifelse(order_coa %in% top12, paste0(order_coa), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  #mutate(Group = fct_recode(Group, P_Thaumarchaeota = "Thaumarchaeota", C_Gammaproteobacteria = "Gammaproteobacteria")) %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Family expression Thaumarchaeota") 
```

## Plotting all the family plots together
```{r}
p_combined <- p1 + p2 + p3 + p4

p_combined

ggsave("../results/nested_families.png", plot = p_combined, height = 20, width = 35, units = "cm")
```

### Nitrospira
```{r}
 bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(treatment, timepoint, genus) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(genus == "Nitrospira genus") %>%
  ggplot(mapping = aes(x= timepoint, y = tpm)) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('phylum', values = GEOM_COL_COLOURS) +
  ylab("Relative abundance") +
  xlab("Day") +
  ggtitle("Nitrospira sp. reads") 
```

### Table with genus abundances (tpm)
```{r}
bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(taxonomy, by = "orf") %>%
  group_by(treatment, timepoint, genus) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>% 
  write_tsv("../results/genus_abundances.tsv")
```


* 4a: Medelantal uttryckta orfar per behandlingsgrupp (diskutera: är temperatur eller näring viktigast för diversitet?)
```{r mean_orfs, message=FALSE, warning=FALSE}
kable(bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  filter(tpm > 0) %>% #Removing zero counts in treatments
  group_by(treatment) %>%
  tally() %>%
  ungroup()) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
    add_header_above(c("Table. average orfs per treatment" = 2), font_size = 18)

bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  group_by(treatment, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  filter(tpm > 0) %>% #Removing zero counts in treatments
  group_by(treatment) %>%
  tally() %>%
  ungroup() %>%
  write_tsv("../results/orf_richness.tsv")
```


```{r}

```

*Gör en tabell med eggnog taxonomi och tpm*
```{r}

```



# Kegg-pathways stacked bars
This gave nothing of real insight, or interesting patterns. Non-hierarchical structure doesn't help.
```{r eval=FALSE}
#Getting the most abundant categories
top12Path <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  select(-t) %>%
  inner_join(eggnogs, by = "orf") %>%
  mutate(KEGG_Pathway = gsub("[a-z]*","", KEGG_Pathway)) %>% #Remove ko and map-prefix to avoid duplication.
  separate_rows(KEGG_Pathway, sep = ",") %>%
  distinct(KEGG_Pathway, treatment, timepoint, orf, tpm) %>% #Getting rid of duplicates due to the removal of prefixes
  group_by(KEGG_Pathway) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  filter(KEGG_Pathway!= "-") %>%
  slice(1:12) %>%
  pull(KEGG_Pathway)

bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  select(-t) %>%
  inner_join(eggnogs, by = "orf") %>%
  mutate(KEGG_Pathway = gsub("[a-z]*","", KEGG_Pathway)) %>% #Remove ko and map-prefix to avoid duplication.
  separate_rows(KEGG_Pathway, sep = ",") %>%
  distinct(KEGG_Pathway, treatment, timepoint, orf, tpm) %>% #Getting rid of duplicates due to the removal of prefixes
  mutate(Group = ifelse(KEGG_Pathway %in% top12Path, paste0(KEGG_Pathway), "Other")) %>%
  group_by(treatment, timepoint, Group) %>% #Summarising mean tpm per timepoint and treatment per group
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x= timepoint, y = tpm, fill = fct_relevel(Group, "Other", after = 12))) +
  geom_col() +
  facet_wrap(~ treatment) +
  theme(axis.text.x = element_text(angle = 60), panel.background = element_blank()) +
  scale_fill_manual('KEGG Pathway', values = GEOM_COL_COLOURS1) +
  ylab("Relative abundance") +
  xlab("Day")
  ggsave("../results/KEGG_paths.png")
  ggsave("../results/KEGG_paths.pdf")
```

# TOP50 genes
```{r top_genes}
annotated_counts <- bbmap_p %>%
  inner_join(eggnogs, by = "orf") %>% #6674350 rows
  inner_join(sample_ID, by = "sample") 

#Top50 genes overall are not stress genes, very good sign! Rather ammonium transport, photosystem, flagellar motorproteins, and others.
  

top50all <- annotated_counts %>%
  group_by(orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:50) %>% 
  inner_join(eggnogs, by = "orf") %>%
  arrange(desc(tpm)) %>%
  pull(orf)
  

#Top genes per treatment
top50 <- annotated_counts %>%
  group_by(treatment, orf) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  group_by(treatment) %>%
  arrange(desc(tpm)) %>%
  top_n(50, tpm) %>% 
  ungroup() %>%
  inner_join(eggnogs, by = "orf") %>% 
  select(orf, Preferred_name, best_og_desc, treatment) 

#Plotting the genes, first in a venn diagram
#Creating vectores with the top15 asv's per treatment
C_orf <- top50 %>%
  filter(treatment == "C") %>%
  .$orf

T_orf <- top50 %>%
  filter(treatment == "T") %>%
  .$orf

N_orf <- top50 %>%
  filter(treatment == "N") %>%
  .$orf

TN_orf <- top50 %>%
  filter(treatment == "NT") %>%
  .$orf

venn.diagram(
  x = list(C_orf, N_orf, T_orf, TN_orf),
  category.names = c("C" , "N", "T","TN"),
  filename = '../results/top50_shared.png',
  output=TRUE
)

# Interestingly not as many shared between all treatments, and quite a few unique genes for the T-treatments
```

## Plotting the abundance of the 50 most abundant genes separated per treatment to see contribution
```{r}
top50 <-  bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  group_by(orf) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:50) %>%
  pull(orf)

#Plotting the top50 genes
plot_ibj <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  group_by(orf, treatment, timepoint) %>%
  summarise(tpm = mean(tpm)) %>%
  ungroup() %>%
  left_join(taxonomy, by ="orf") 

  p <- plot_ibj %>%
    filter(orf %in% top50) %>%
    ggplot(mapping = aes(x = orf, y = tpm, fill = treatment)) +
    geom_col(position = "dodge") +
    theme(axis.text.x = element_text(hjust = 1, angle = 60)) +
    facet_wrap(~ timepoint)
  
  ggplotly(p)
  
  #Trying the pheatmap way to investigate the top50 genes, and their annotation
  top50_matr <- plot_ibj %>%
    filter(orf %in% top50) %>%
    mutate(treatpoint = paste(treatment, timepoint, sep = "_")) %>%
    select(orf,treatpoint, tpm) %>%
    spread(treatpoint, tpm, fill = 0) %>%
    column_to_rownames("orf") %>%
    as.matrix()
  
  #MAKE TREATMENT VECTOR
Treatment <- c("C","C","N","N","T","T","TN","TN")


#Connecting the annotation column by adding rownames to match colnames in matrix
ann_col <- data.frame(Treatment)
rownames(ann_col) <- colnames(top50_matr)
col_vec <- rep(c("10","15"), times = 4)

my_colour = list(Treatment =c("C" = "blue", "N" = "green3", "T" = "red", "TN" = "yellow4")
)

#Lastly add annotation fore the rows based on eggnog-annotation.
row_names <- top50_matr %>%
  as.data.frame() %>%
  rownames_to_column("orf") %>%
  left_join(eggnogs, by = "orf") %>%
  select(orf, Preferred_name) %>%
  column_to_rownames("orf") %>%
  pull(Preferred_name)

top50_matr %>%
  as.data.frame() %>%
  rownames_to_column("orf") %>%
  left_join(eggnogs, by = "orf") %>%
  select(orf, Preferred_name) %>%
  column_to_rownames("orf") %>% view()

#Add zero values in a different colour for identifying absence of genes
  
pheatmap(top50_matr, cluster_cols = F, clustering_distance_rows = "correlation",annotation_col = ann_col, labels_col = col_vec, labels_row = row_names ,gaps_col = c(2,4,6,8), annotation_colors = my_colour)

p2 <- pheatmap(top50_matr, cluster_cols = F, clustering_distance_rows = "correlation", annotation_col = ann_col, scale = "row",labels_col = col_vec, labels_row = row_names ,gaps_col = c(2,4,6,8), annotation_colors = my_colour, treeheight_row = 0, fontsize = 5, border_color = NA)

p1 <- pheatmap(top50_matr, cluster_cols = F, clustering_distance_rows = "correlation",annotation_col = ann_col, labels_col = col_vec, labels_row = row_names, show_rownames = F ,gaps_col = c(2,4,6,8), annotation_colors = my_colour,annotation_names_col = F, annotation_legend = F, fontsize =5, border_color = NA)

# Out of the 50 most abundant genes, the majority are unidentified, the motility response is very strong in the TN treatment as seen by the expression of the fliM gene, which is also the most abundant gene in the C treatment. A suite of unknown genes are also representative for the C-treatment as they for a very distinct cluster.


pdf("../results/top50_both.pdf")
grid.arrange(grobs = list(p1[[4]],
                          p2[[4]]
), ncol = 2)

grid.arrange(grobs = list(p1[[4]],
                          p2[[4]]
), ncol = 2)
dev.off()
```

## Most abundant KEGG-modules across all treatments
```{r}
top50 <-  bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(KEGG_Module, sep = ",") %>%
  group_by(KEGG_Module) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_Module != "-") %>%
  arrange(desc(tpm)) %>%
  slice(1:50) %>%
  pull(KEGG_Module)

top50

#Module legend
#M00178 - No entry
#M00179 - No entry
#M00157 - F-type ATPase, prokaryotes and chloroplast
#M00237 - No entry
#M00804 - Complete nitrification, comammox, ammonia => nitrite => nitrate
#M00174 - Methane oxidation, methanotroph, methane => formaldehyde
#M00528 - Nitrification, ammonia => nitrite
#M00222 - No entry
#M00183 - No entry
#M00009 - Citrate cycle (TCA cycle, Krebs cycle)
#M00335 - No entry
#M00011 - Citrate cycle, second carbon oxidation, 2-oxoglutarate => oxaloacetate
#M00173 - Reductive citrate cycle (Arnon-Buchanan cycle)
#M00083 - Fatty acid biosynthesis, elongation
#M00529 - Denitrification, nitrate => nitrogen
#M00374 - Dicarboxylate-hydroxybutyrate cycle
#M00360 - No entry
#M00359 - No entry
#M00232 - No entry 
#M00082 - Fatty acid biosynthesis, initiation
#M00012 - Glyoxylate cycle
#M00570 - Isoleucine biosynthesis, threonine => 2-oxobutanoate => isoleucine
#M00019 - Valine/isoleucine biosynthesis, pyruvate => valine / 2-oxobutanoate => isoleucine
#M00053 - Deoxyribonucleotide biosynthesis, ADP/GDP/CDP/UDP => dATP/dGTP/dCTP/dUTP
#M00048 - De novo purine biosynthesis, PRPP + glutamine => IMP
#M00742 - No entry
#M00144 - NADH:quinone oxidoreductase, prokaryotes
#M00155 - Cytochrome c oxidase, prokaryotes
#M00087 - beta-Oxidation
#M00003 - Gluconeogenesis, oxaloacetate => fructose-6P
#M00376 - 3-Hydroxypropionate bi-cycle
#M00532 - Photorespiration
#M00373 - Ethylmalonyl pathway
#M00001 - Glycolysis (Embden-Meyerhof pathway), glucose => pyruvate
#M00017 - Methionine biosynthesis, aspartate => homoserine => methionine
#M00572 - Pimeloyl-ACP biosynthesis, BioC-BioH pathway, malonyl-ACP => pimeloyl-ACP
#M00032 - Lysine degradation, lysine => saccharopine => acetoacetyl-CoA
#M00740 - Methylaspartate cycle
#M00620 - Incomplete reductive citrate cycle, acetyl-CoA => oxoglutarate
#M00036 - Leucine degradation, leucine => acetoacetate + acetyl-CoA
#M00172 - C4-dicarboxylic acid cycle, NADP - malic enzyme type
#M00169 - CAM (Crassulacean acid metabolism), light
#M00016 - Lysine biosynthesis, succinyl-DAP pathway, aspartate => lysine
#M00346 - Formaldehyde assimilation, serine pathway
#M00236 - No entry
#M00165 - Reductive pentose phosphate cycle (Calvin cycle)
#M00307 - Pyruvate oxidation, pyruvate => acetyl-CoA
#M00151 - Cytochrome bc1 complex respiratory unit
#M00152 - Cytochrome bc1 complex
#M00394 - No entry.

#While a lot of the abundant modules have no entry in the database. Among the most abundant modules are the over-represented categories in nitrogen metabolism, along with denitrification and methane oxidation (most likely ammonia oxidation, but not necessarily). Other abundant categories included the TCA-cycle, reductive TCA-cycle,an ATPase and fatty acid biosynthesis (elongation). Interestingly, since not many were found to be over-represented, instead characteristics for the entire community included modules in Nitrogen metabolism, such as comammox, denitrification, and  dissimilatory nitrate reduction.

#Create table with top 50, and annotate whether or not they are over-represented
top_50_mods <- bbmap_p %>%
  inner_join(sample_ID, by = "sample") %>%
  dplyr::select(-tpm) %>%
  group_by(treatment,timepoint) %>%
            mutate(t = count/Length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
            ungroup() %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(KEGG_Module, sep = ",") %>%
  group_by(KEGG_Module) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_Module != "-") %>%
  arrange(desc(tpm)) %>%
  inner_join(module_legend, by = "KEGG_Module","Module") 
```

```{r eggnog_cats_per_treatment, eval=FALSE}
p <- annotated_counts %>%
  separate_rows(best_og_cat, sep = '(?<=.)(?=.)') %>%
  group_by(treatment,best_og_cat) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = treatment, y = tpm, fill = best_og_cat)) +
  geom_col(position = "dodge")

ggplotly(p)

#Categories high in C - P
 # Categories high in low temp - C, J

# Legend
  # P - Inorganic ion transport and metabolism (Maybe membrane potential?)
  # C - Energy production and conversion 
  # J - Translation, ribosomal structure and biogenesis

```

#Investigating the differentially expressed genes
```{r}
DEGs <- read_tsv("../results/DEG.tsv")
```

## C-treatment
```{r}
C_up <- DEGs %>%
  filter(logFC >= DIFF_TRESHOLD) %>%
  select(orf) %>%
  left_join(eggnogs, by = "orf")

 DEGs %>%
  filter(logFC >= DIFF_TRESHOLD) %>%
  select(orf) %>%
  left_join(eggnogs, by = "orf") %>%
  filter(best_og_desc == "Ammonium Transporter") 

#Among the genes upregulated in the C-treatment, were several ammonium transporters (>10) all belonging to Thaumarchaeota. Different secretion systems, and genes that are part of the lux-regulon (quorom-sensing).
 
 C_up %>%
  left_join(taxonomy, by = "orf") %>%
  group_by(class) %>%
  tally() %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  mutate(percentage = n/sum(n) * 100) %>%
  write_tsv("../results/C_up_summary.tsv")
```

## TN-treatment
```{r}
DEGs %>%
  filter(logFC <= -DIFF_TRESHOLD) %>%
  select(orf) %>%
  left_join(eggnogs, by = "orf") %>%
  filter(best_og_desc == "Ammonium transporter") 

#Interestingly, 8 of the downregulated genes (= elevated in the TN treatment) were also ammonium transporters. However these were instead expressed by bacteria. genes involved in growth on fatty acid substrate also found, not present in C-treatment

TN_up <- DEGs %>%
  filter(logFC <= -DIFF_TRESHOLD) %>%
  select(orf) %>%
  left_join(eggnogs, by = "orf")

TN_up %>%
  left_join(taxonomy, by = "orf") %>%
  group_by(class) %>%
  tally() %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  mutate(percentage = n/sum(n) * 100) %>%
  write_tsv("../results/TN_up_summary.tsv")
```

## Nutrient concentrations plot
```{r}
nut_conc %>%
  mutate(Sampling = as.factor(Sampling)) %>%
  ggplot(mapping = aes(x = TDN, y = TDP)) +
  geom_point(aes(shape = Sampling)) +
  facet_wrap( ~ Treatment)

#TDN
nut_conc %>%
  group_by(Sampling, Treatment) %>%
  summarise(mean_tdp = mean(TDP), stdev_tdp = sd(TDP),
            mean_tdn = mean(TDN), stdev_tdn = sd(TDN)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = Sampling, y = mean_tdn)) +
  geom_line(aes(x = Sampling, y = mean_tdn, colour = Treatment)) +
  geom_errorbar(aes(ymin=mean_tdn-stdev_tdn, ymax=mean_tdn +stdev_tdn), width=.2)

#TDP
nut_conc %>%
  group_by(Sampling, Treatment) %>%
  summarise(mean_tdp = mean(TDP), stdev_tdp = sd(TDP),
            mean_tdn = mean(TDN), stdev_tdn = sd(TDN)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = Sampling, y = mean_tdp)) +
  geom_line(aes(x = Sampling, y = mean_tdp, colour = Treatment)) +
  geom_errorbar(aes(ymin=mean_tdp-stdev_tdp, ymax=mean_tdp +stdev_tdp), width=.2)

# Ratio suggests P-limitation
nut_conc %>%
  mutate(ratio = TDN/TDP) %>%
  group_by(Sampling, Treatment) %>%
  summarise(mean_ratio = mean(ratio), stdev = sd(ratio)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = Sampling, y = mean_ratio)) +
  geom_line(aes(colour = Treatment)) +
  geom_errorbar(aes(ymin=mean_ratio-stdev, ymax=mean_ratio +stdev), width=.2)

```

## DOC
```{r}
DOC_doc <- read_tsv("../data/DOC.txt")

### Pretty up and combine all nutrient and DOC graphs into one!
DOC_doc %>%
  group_by(Sampling, Treatment) %>%
  summarise(mean_doc = mean(DOC), stdev_doc = sd(DOC)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = Sampling, y = mean_doc)) +
  geom_line(aes(x = Sampling, y = mean_doc, colour = Treatment)) +
  geom_errorbar(aes(ymin=mean_doc-stdev_doc, ymax=mean_doc +stdev_doc), width=.2)
```
## Combining and plotting nuts + DOC

```{r}
nut_conc %>%
  select(-TDN) %>%
  mutate(variable = "TDP") %>%
  rename(value = TDP)

nut_conc %>%
  select(-TDP) %>%
  mutate(variable = "TDN") %>%
  rename(value = TDN)

#Creating the same for DOC
DOC_doc %>%
  mutate(variable = "DOC")  %>%
  rename(value = DOC) %>%
  select(-Day_of_experiment)

rbind(
  nut_conc %>%
  select(-TDN) %>%
  mutate(variable = "TDP") %>%
  rename(value = TDP),
  nut_conc %>%
  select(-TDP) %>%
  mutate(variable = "TDN") %>%
  rename(value = TDN),
  DOC_doc %>%
  mutate(variable = "DOC")  %>%
  rename(value = DOC) %>%
  select(-Day_of_experiment)
) %>%
  group_by(Sampling, Treatment, variable) %>%
  summarise(mean = mean(value), stdev = sd(value)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = Sampling, y = mean)) +
  geom_line(aes(x = Sampling, y = mean, colour = Treatment)) +
  geom_errorbar(aes(ymin=mean-stdev, ymax=mean +stdev), width=.2, position = "dodge2") +
  facet_wrap(~ variable, scales = "free_y") +
  theme_minimal() +
  scale_colour_manual(values = TREAT_COLOURS) 

ggsave("../results/nutrient_plots.png")
  
```

## Nitrospira (table of tpm for each genus)
```{r}

```

# Results
